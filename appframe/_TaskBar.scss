@use "../design/ColorVars" as cl;
@use "../design/ColorUtils" as cu;

//
@use "../core/Utils" as u;
@use "../core/ClassLets";
@use "../design/ColorTheme";

//
@use "../core/Detector" as d;

//
@mixin collapse {
    //
    visibility: collapse !important;
    pointer-events: none !important;
    overflow: hidden !important;
    
    //
    & *:not(.ux-app-frame, .ux-content) {
        visibility: collapse !important;
        pointer-events: none !important;
        overflow: hidden !important;
    }
}

//
@mixin whenDesktop {
    --padding-top: 0px;

    //
    &:not(:has(.ux-app-frame:not(.ux-detached))) {
        grid-template-rows: 
            [titlebar] 0px
            [content-b] minmax(0px, 1fr);

        //
        & > .titlebar { 
            @include collapse;
        }
    }
}

//
@mixin whenMobile {
    //
    --padding: 0rem;
    --padding-top: max(env(safe-area-inset-top, 0px), 2rem);

    //
    --theme-glyph-color: #{cu.theme-mod-down(cl.$baseColor, 90%)};
    --theme-surface-color: #{cu.theme-mod-up(cl.$baseColor, 90%)};
    --highlight-coefficient: 6;

    //
    grid-template-rows: 
        [content-b] minmax(0px, 1fr)
        [titlebar] minmax(0px, var(--real-taskbar-height));

    //
    padding-block-end: 0px;

    //
    & .ux-task-list {
        align-self: end;
        translate: 0px calc(0px - var(--min-taskbar-height));
        z-index: 9999;
        
        //
        flex-direction: column;
        align-self: end;
        
        //
        & .ux-task-box {
            max-inline-size: none;
            
            //
            &.ux-focus {
                display: none;
            }
        }
    }

    //
    & .titlebar {
        align-self: end;
        
        //
        & > :where(.back-button, .menu-button) {
            border-radius: 0.125rem;
        }
        
        //
        & > :where(.ux-task-button) {
            display: flex !important;
            
            //
            & .ux-task-box {
                max-inline-size: none;
                pointer-events: none;
                
                //
                &:not(.ux-focus) {
                    display: none;
                }
            }
        }
    }
    
    //
    &.ux-overlay {
        --real-taskbar-height: 0px;
    }
}

//
@layer ux-taskbar {
    
    //
    .ux-taskbar {
        //
        @extend .contain-size;
        @extend .align-center;
        @extend .stretch !optional;
        @extend .ux-solid-transparent;
        @extend .pe-none;

        //
        --min-taskbar-height: 3rem;
        --real-taskbar-height: 3rem;
        
        //
        --padding: 0rem;
        --padding-top: 0rem;
        --padding-left: calc(var(--padding) + env(safe-area-inset-left, 0px));
        --padding-right: calc(var(--padding) + env(safe-area-inset-right, 0px));

        //
        outline: solid 0.25px oklch(from var(--current-glyph-color) l c h / 0.0);
        
        //
        transition: outline-color 200ms;
        translate: 0px 0px 0px;
        
        //
        overflow: visible;
        position: fixed;
    
        //
        inset: 0px;
        z-index: 999;
        display: grid;
        contain: content;
        container-type: size;
        container-name: ux-taskbar;
        box-sizing: border-box;

        //
        font-size: 0.9rem;

        //
        grid-template-columns: 
            [menu-button] minmax(3rem, max-content)
            [title-label] minmax(0px, 1fr)
            [back-button] minmax(3rem, max-content);
    
        //
        grid-template-rows: 
            [titlebar] minmax(0px, var(--real-taskbar-height))
            [content-b] minmax(0px, 1fr);

        //
        padding-block-start: var(--padding-top);
        //padding-block-end: max(env(safe-area-inset-bottom, 0px), 2rem);

        //
        &:hover { outline: solid 0.5px oklch(from var(--current-glyph-color) l c h / 0.125); }
        &:not(:has(.ux-app-frame)) { @include collapse;  }
        
        //
        &.ux-overlay {
            --real-taskbar-height: 0px;

            //
            & > .titlebar {
                z-index: 9999;
                box-shadow: 0px 0px 1rem 1px #00000070;
            }
            
            //
            & > .ux-task-list {
                z-index: 9999 + 1;
            }
        }

        //
        & .ux-task-box {
            @extend .align-center;
            @extend .stretch;
            @extend .pe-enable;
            
            //
            //grid-column: title-label;
            //grid-row: 1 / 1 span;
            
            //
            cursor: pointer;
            
            //
            display: grid;
            max-inline-size: 8rem;
            position: relative;
            box-sizing: border-box;
            
            //
            min-block-size: var(--min-taskbar-height);
            max-block-size: var(--min-taskbar-height);
            
            //
            grid-template-columns: minmax(0px, 3rem) minmax(max-content, 1fr);
            grid-template-rows: minmax(0px, 1fr) minmax(0px, 0.25rem);
            
            //
            .ux-task-label, .ux-task-icon {
                grid-row: 1 / 2 span;
            }
            
            //
            .ux-task-icon {
                grid-column: 1 / 1 span;
            }
            
            //
            .ux-task-label {
                grid-column: 2 / 2 span;
                justify-self: start;
            }
            
            //
            &::after {
                @extend .stretch;
                @extend .pe-none;

                //
                --theme-surface-color: #{cl.$baseColor};
                --theme-glyph-color: oklch(from #{cl.$baseColor} calc(sign(calc(0.5 - l)) * 0.5 + 0.5) calc(c * 0.01) h);
                
                //
                padding: 0px;
                margin: 0px;
                line-height: 0px;
                
                //
                background-color: var(--theme-surface-color);
                grid-row: 2 / 2 span;
                grid-column: 1 / 2 span;
                
                //
                box-sizing: border-box;
                content: "";
                display: block;
            }
        }
        
        //
        & > .ux-task-list {
            @extend .stretch;
            @extend .align-center;
            @extend .align-inline-left;
            @extend .no-wrap;
            @extend .ux-solid;

            //
            z-index: 999;
            padding: 0rem;
            display: flex;
            grid-column: title-label;
            grid-row: titlebar;
            overflow: visible;
            
            //
            align-self: start;
            
            //
            block-size: max-content;
            min-block-size: max-content;
            max-block-size: none;
            flex-direction: row;

            //
            font-weight: 600;
            font-size: 1rem;
        }
        
        //
        & > .titlebar {
            @extend .align-center;
            @extend .stretch;
            @extend .pe-enable;
            @extend .no-wrap;
            
            //
            grid-row: titlebar;
            grid-column: 1 / 3 span;
            grid-template-columns: subgrid;
            grid-template-rows: minmax(0px, 1fr);
            overflow: hidden;
            
            //
            gap: 0px;
            
            //
            align-items: end;
            align-self: start;
            box-sizing: border-box;
            block-size: max-content;
            
            //
            min-block-size: var(--min-taskbar-height);
            max-block-size: var(--min-taskbar-height);
        
            //
            display: grid;
            z-index: 99;
            
            //
            padding-block: var(--padding, 0px);
            padding-inline: max(var(--padding-left), var(--padding)) max(var(--padding-right), var(--padding));

            //
            & > * {
                @extend .align-center;
                @extend .stretch;
                
                //
                padding: 1rem;
                display: flex;
                grid-row: 1 / 1 span;
            }

            //
            & > .ux-task-button {
                @extend .stretch;
                @extend .align-center;
                @extend .align-inline-left;
                @extend .no-wrap;
                @extend .ux-solid;
    
                //
                z-index: 999;
                padding: 0rem;
                display: none;
                grid-column: title-label;
                grid-row: 1 / 1 span;
                overflow: hidden;
                
                //
                flex-direction: row;
                //min-inline-size: max-content;
                
                //
                font-weight: 600;
                font-size: 1rem;
            }
            
            //
            & > :where(.back-button, .menu-button) {
                padding: 0.75rem;
                cursor: pointer;
                
                //
                max-inline-size: var(--min-taskbar-height);
                max-block-size: var(--min-taskbar-height);
            }
        }
        
        //
        @container ux-taskbar #{d.$isNotWide} { @include whenMobile; }
        @media #{d.$isMobile} { @include whenMobile; }
        @media #{d.$isDesktop} { @include whenDesktop; }
    }
}
